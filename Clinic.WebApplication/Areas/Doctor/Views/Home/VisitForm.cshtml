@model AddVisitViewModel
@inject AppDbContext DbContext
@{
    var patientName = await DbContext.Patients.FindAsync(Model.Reservation.PatientId);
    ViewBag.Title = "نوشتن ویزیت برای " + patientName.FullName;

    List<SelectListItem> insuranceList = new List<SelectListItem>();
    foreach (var insurance in await DbContext.InsuranceProviders.ToListAsync())
    {
        insuranceList.Add(new SelectListItem { Text = insurance.InsuranceName, Value = insurance.InsuranceName });
    }
}

<div class="container">
    <div class="row">
        <div class="col-md-12">
            <div class="card-box">
                <form id="addVisitForm" asp-action="AddVisit" method="post">
                    <input asp-for="Reservation.PatientId" type="hidden" />
                    <input asp-for="Reservation.DoctorId" type="hidden" />
                    <input asp-for="Reservation.ReserveDate" type="hidden" />
                    <div class="row">
                        <div class="col-md-6">
                            <h4 class="header-title m-t-0 m-b-30">مشخصات ویزیت</h4>
                            <hr />
                            <div class="form-group">
                                <label asp-for="Visit.CauseOfPatientReferral"></label>
                                <input asp-for="Visit.CauseOfPatientReferral" class="form-control" placeholder="دلیل مراجعه بیمار">
                                <span class="text-danger" asp-validation-for="Visit.CauseOfPatientReferral"></span>
                            </div>
                            <div class="form-group">
                                <label asp-for="Visit.DoctorAssessment"></label>
                                <input asp-for="Visit.DoctorAssessment" class="form-control" placeholder="تشخیص پزشک">
                                <span class="text-danger" asp-validation-for="Visit.DoctorAssessment"></span>
                            </div>
                            <div class="form-group">
                                <label asp-for="Visit.DoctorNote"></label>
                                <input asp-for="Visit.DoctorNote" class="form-control" placeholder="در صورت نیاز یادداشتی برای ویزیت بنویسید">
                                <span class="text-danger" asp-validation-for="Visit.DoctorNote"></span>
                            </div>
                            <br />
                        </div>
                        <div class="col-md-6">
                            <h4 class="header-title m-t-0 m-b-30">نسخه</h4>
                            <hr />
                            <div class="form-group">
                                <label asp-for="DrugList"></label>
                                <input asp-for="DrugList" class="form-control" />
                                <span class="help-block"><small>مثال: آستامینافن،1،سرماخوردگی،2</small></span>
                                <span class="text-danger" asp-validation-for="DrugList"></span>
                            </div>
                            <div class="form-group">
                                <label asp-for="InsuranceProviderName"></label>
                                <select class="form-control" asp-for="InsuranceProviderName" asp-items="insuranceList">
                                    <option value="">انتخاب کنید</option>
                                </select>
                                <span class="help-block"><small>در صورت عدم ارائه بیمه توسط بیمار، این فیلد را خالی بگذارید</small></span>
                                <span class="text-danger" asp-validation-for="InsuranceProviderName"></span>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <h4 class="header-title m-t-0 m-b-30">ویزیت دوباره</h4>
                            <div class="form-group">
                                <label asp-for="ReserveDateAgain"></label>
                                <input asp-for="ReserveDateAgain" id="pcal1" class="form-control pdate">
                                <span class="text-danger" asp-validation-for="ReserveDateAgain"></span>
                            </div>
                            <br />
                            <div class="form-group">
                                <label asp-for="ReserveTimeAgain"></label>
                                <select asp-for="ReserveTimeAgain" class="form-control">
                                    <option selected="">ساعت مورد نظر را انتخاب کنید</option>
                                    <option value="08:00:00">8-10</option>
                                    <option value="10:00:00">10-12</option>
                                    <option value="12:00:00">12-14</option>
                                    <option value="14:00:00">14-16</option>
                                </select>
                                <span class="text-danger" asp-validation-for="ReserveTimeAgain"></span>
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <button type="submit" class="btn btn-success">ثبت ویزیت</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Head
{
    <link rel="stylesheet" href="/Administrators/assets/css/calendar/jspc-royal_blue.css">
    <link href="/Administrators/assets/plugins/bootstrap-sweetalert/sweet-alert.css" rel="stylesheet" type="text/css" />
    <script src="/Administrators/assets/plugins/bootstrap-sweetalert/sweet-alert.min.js"></script>
    <!-- scripts -->
    <script type="text/javascript" src="/Administrators/assets/css/calendar/js-persian-cal.min.js"></script>
}

@section Scripts
{
    <script type="text/javascript">
        var objCal1 = new AMIB.persianCalendar('pcal1');
    </script>
    <script>
        $("#addVisitForm").submit(function(e) {
            e.preventDefault();

            var form = $(this);
            var url = form.attr('action');
            if ($('#Visit_CauseOfPatientReferral').val() && $('#Visit_DoctorAssessment').val()) {
                swal({
                title: "مطمئنی ؟؟",
                text: "آیا از افزودن ویزیت مطمئن هستی؟",
                type: "warning",
                showCancelButton: true,
                confirmButtonClass: 'btn-success waves-effect waves-light',
                confirmButtonText: 'بله!',
                closeOnConfirm: false
            },
            function(isConfirm) {
                if (isConfirm) {
                    $.ajax({
                        type: "POST",
                        url: url,
                        data: form.serialize(),
                        success: function() {
                            swal({
                                title: "تبریک!",
                                text: "ویزیت با موفقیت انجام شد",
                                timer: 3000,
                                showConfirmButton: false
                            });
                            window.location.href =
                                '@Url.Action("Index", "Home")';
                        },
                        statusCode: {
                            404: function() {
                                swal({
                                        title: "دسترسی غیر مجاز!",
                                        text: "لطفا از دستکاری داده های ارسالی اجتناب کنید!",
                                        type: "error",
                                        showCancelButton: false,
                                        confirmButtonClass: 'btn-danger waves-effect waves-light',
                                        confirmButtonText: 'باشه ببخشید!',
                                        closeOnConfirm: true
                                    }
                                );
                            },
                            400: function () {
                                swal({
                                    title: "خطا!",
                                    text: "امکان ویزیت دوباره در این تاریخ و ساعت بدلیل تداخل با برنامه روزانه شما وجود ندارد!",
                                    type: "error",
                                    showCancelButton: false,
                                    confirmButtonClass: 'btn-danger waves-effect waves-light',
                                    confirmButtonText: 'باشه!',
                                    closeOnConfirm: true
                                });
                            },
                            401: function () {
                                swal({
                                    title: "خطا!",
                                    text: "امکان ویزیت دوباره در روز جمعه وجود ندارد!",
                                    type: "error",
                                    showCancelButton: false,
                                    confirmButtonClass: 'btn-danger waves-effect waves-light',
                                    confirmButtonText: 'باشه!',
                                    closeOnConfirm: true
                                });
                            },
                            402: function() {
                                swal({
                                    title: "خطا!",
                                    text: "ساعت ویزیت دوباره فرمت مناسبی ندارد!",
                                    type: "error",
                                    showCancelButton: false,
                                    confirmButtonClass: 'btn-danger waves-effect waves-light',
                                    confirmButtonText: 'باشه!',
                                    closeOnConfirm: true
                                });
                            },
                            403: function () {
                                swal({
                                    title: "خطا!",
                                    text: "لطفا در نوشتن داروها دقت کنید!",
                                    type: "error",
                                    showCancelButton: false,
                                    confirmButtonClass: 'btn-danger waves-effect waves-light',
                                    confirmButtonText: 'باشه!',
                                    closeOnConfirm: true
                                });
                            },
                            405: function () {
                                swal({
                                    title: "خطا!",
                                    text: "شما در این زمان با بیمار دیگری وقت ملاقات دارید!",
                                    type: "error",
                                    showCancelButton: false,
                                    confirmButtonClass: 'btn-danger waves-effect waves-light',
                                    confirmButtonText: 'باشه!',
                                    closeOnConfirm: true
                                });
                            },
                            406: function () {
                                swal({
                                    title: "خطا!",
                                    text: "امکان ویزیت دوباره در گذشته و امروز وجود ندارد!",
                                    type: "error",
                                    showCancelButton: false,
                                    confirmButtonClass: 'btn-danger waves-effect waves-light',
                                    confirmButtonText: 'باشه!',
                                    closeOnConfirm: true
                                });
                            },
                            409: function () {
                                swal({
                                    title: "خطا!",
                                    text: "ثبت بیمه بدون نوشتن نسخه امکان پذیر نیست!",
                                    type: "error",
                                    showCancelButton: false,
                                    confirmButtonClass: 'btn-danger waves-effect waves-light',
                                    confirmButtonText: 'باشه!',
                                    closeOnConfirm: true
                                });
                            }
                        }
                    });
                }
            });
            }
        });
    </script>
}